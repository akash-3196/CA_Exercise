.PHONY: all clean benchmark_loop print_flags

ROOT_PATH   := .
SRC_PATH    := $(ROOT_PATH)/src
BUILD_PATH  := $(ROOT_PATH)/build
BIN_PATH    := $(ROOT_PATH)/bin

INC_PATH    := $(SRC_PATH)/include
INC_DIRS    := $(sort $(shell find $(INC_PATH) -type d))
INC_FLAGS   := $(addprefix -I, $(INC_DIRS))

CC          := icc
CFLAGS      := -Wall -pedantic -Werror -std=c99 -O3 -pg -xHost

# Likwid Flags 
# Makefile ( choose <latest > as e.g .: 5.3.0)
INC_PATH += -I/apps/likwid/5.3.0/include
CFLAGS_LIKWID := -I/apps/likwid/5.3.0/include -DLIKWID_PERFMON
LDLAGS_LIKWID := -pthread -L/apps/likwid/5.3.0/lib/ -llikwid

# Default UNROLL_FACTOR value
#UNROLL_FACTOR ?= 4

#LDFLAGS     := -lm

all: benchmark_loop

clean:
	rm -rf $(BUILD_PATH) $(BIN_PATH)

benchmark_loop: $(BIN_PATH)/benchmark_loop

$(BIN_PATH)/benchmark_loop: $(BUILD_PATH)/main.o $(BUILD_PATH)/jacobi.o $(BUILD_PATH)/get_time.o $(BUILD_PATH)/helper_func.o $(BUILD_PATH)/draw.o $(BUILD_PATH)/vec_sum.o
	mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(CFLAGS_LIKWID) $^ -o $@ $(LDFLAGS) $(LDLAGS_LIKWID)

$(BUILD_PATH)/%.o: $(SRC_PATH)/%.c
	mkdir -p $(dir $@)
	$(CC) $(INC_FLAGS) $(CFLAGS) -MMD -MP -c $< -o $@

# Include generated dependency files
-include $(wildcard $(BUILD_PATH)/*.d)

print_flags:
    @echo "CFLAGS_LIKWID: $(CFLAGS_LIKWID)"
    @echo "LDLAGS_LIKWID: $(LDLAGS_LIKWID)"
    @echo "Compilation command: $(CC) $(CFLAGS) $(CFLAGS_LIKWID)  $^ -o $@ $(LDFLAGS) $(LDLAGS_LIKWID)"
